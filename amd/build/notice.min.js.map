{"version":3,"sources":["../src/notice.js"],"names":["define","$","ajax","ModalFactory","ModalNotice","notices","modal","viewednotices","SiteNotice","getNotice","i","includes","push","nextNotice","nextnotice","create","type","TYPE","title","body","content","large","then","newmodal","setNoticeId","id","setRequiredAcknowledgement","reqack","getModal","on","getCloseButtonID","dismissNotice","hide","getAcceptButtonID","acknowledgeNotice","linkid","attr","trackLink","getAckCheckboxID","ischecked","is","turnonToolTip","turnoffToolTip","show","focus","setTitle","setBody","noticeid","getNoticeId","promises","call","methodname","args","done","response","redirecturl","window","open","fail","ex","console","log","init","JSON","parse","document","ready"],"mappings":"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","sourcesContent":["/**\n * User interaction with notice\n * @author     Nathan Nguyen <nathannguyen@catalyst-au.net>\n * @copyright  Catalyst IT\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    ['jquery', 'core/ajax', 'core/modal_factory', 'local_sitenotice/modal_notice'],\n    function ($, ajax, ModalFactory, ModalNotice) {\n\n        var notices = {};\n        var modal;\n        var viewednotices = [];\n\n        var SiteNotice = {};\n\n        /**\n         * Retrieved notice which has not been viewwed.\n         * @returns {boolean|*}\n         */\n        var getNotice = function() {\n            for (var i in notices) {\n                // Check the notice has been viewed.\n                if (!viewednotices.includes(i)) {\n                    viewednotices.push(i);\n                    return notices[i];\n                }\n            }\n            return false;\n        };\n\n        /**\n         * Show next notice in the modal.\n         */\n        var nextNotice = function () {\n            var nextnotice = getNotice();\n            if (nextnotice == false) {\n                return;\n            }\n            if (typeof modal === 'undefined') {\n                ModalFactory.create({\n                    type: ModalNotice.TYPE,\n                    title: nextnotice.title,\n                    body: nextnotice.content,\n                    large: true,\n                })\n                .then(function (newmodal) {\n                    modal = newmodal;\n\n                    modal.setNoticeId(nextnotice.id);\n                    modal.setRequiredAcknowledgement(nextnotice.reqack);\n\n                    // Event listener for close button.\n                    modal.getModal().on('click', modal.getCloseButtonID(), function() {\n                        dismissNotice();\n                        modal.hide();\n                    });\n                    // Event listener for accept button.\n                    modal.getModal().on('click', modal.getAcceptButtonID(), function() {\n                        acknowledgeNotice();\n                        modal.hide();\n                    });\n                    // Event listener for link tracking.\n                    modal.getModal().on('click', 'a', function() {\n                        var linkid = $(this).attr(\"data-linkid\");\n                        trackLink(linkid);\n                    });\n                    // Event listener for ack checkbox.\n                    modal.getModal().on('click', modal.getAckCheckboxID(), function() {\n                        var ischecked = $(modal.getAckCheckboxID()).is(\":checked\");\n                        $(modal.getAcceptButtonID()).attr('disabled', !ischecked);\n                        if (!ischecked) {\n                            modal.turnonToolTip();\n                        } else {\n                            modal.turnoffToolTip();\n                        }\n                    });\n\n                    modal.show();\n                    modal.getModal().focus();\n                });\n            } else {\n                // Update with new details.\n                modal.setTitle(nextnotice.title);\n                modal.setBody(nextnotice.content);\n                modal.setNoticeId(nextnotice.id);\n                modal.setRequiredAcknowledgement(nextnotice.reqack);\n                modal.show();\n                modal.getModal().focus();\n            }\n        };\n\n        /**\n         * Dismiss Notice.\n         */\n        var dismissNotice = function () {\n            var noticeid = modal.getNoticeId();\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_dismiss', args: { noticeid: noticeid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                } else {\n                    nextNotice();\n                }\n            }).fail(function(ex) {\n                // TODO: Log fail event.\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Acknowledge notice.\n         */\n        var acknowledgeNotice = function () {\n            var noticeid = modal.getNoticeId();\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_acknowledge', args: { noticeid: noticeid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                } else {\n                    nextNotice();\n                }\n            }).fail(function(ex) {\n                // TODO: Log fail event.\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Link tracking.\n         * @param {Integer} linkid\n         */\n        var trackLink = function (linkid) {\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_tracklink', args: {linkid: linkid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                }\n            }).fail(function(ex) {\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Initial Modal with user notices.\n         */\n        SiteNotice.init = function() {\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_getnotices', args: {} }\n            ]);\n\n            promises[0].done(function(response) {\n                notices = JSON.parse(response.notices);\n                $(document).ready(function() {\n                    nextNotice();\n                });\n            }).fail(function(ex) {\n                this.console.log(ex);\n            });\n        };\n\n        return SiteNotice;\n    }\n);"],"file":"notice.min.js"}